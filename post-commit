#!/bin/bash

unset GIT_DIR

DWL_URL="https://github.com/taishingi/continuous-template/archive/refs/tags/0.0.4.zip"
RELEASE="0.0.4.zip"
SUM="cf82373f697d79bd4d8c7966084c9f223522800c0ab87b3c0fe71e8580103dc5  ${RELEASE}"
DIR=$(realpath .)
BRANCHES=('master')
REMOTES=('origin')

function download() {

	if [ -f	"$DIR/${RELEASE}" ];then
		rm "${DIR}/${RELEASE}"
	fi

    wget --quiet "${DWL_URL}" || exit 1

    DOWN_SUM=$(sha256sum ${RELEASE})
	echo $DOWN_SUM
    if [ "${SUM}" == "${DOWN_SUM}" ]; then
        echo "Signature OK"
        if [ -d "./continuous" ]; then
            rm -rf ./continuous
        fi
        unzip ${RELEASE} || exit 1
        mv "continuous-template-0.0.4" continuous || exit 1

        for x in "rust" "go"; do
            cd "${DIR}/continuous/${x}" && ./scripts-gen || exit 1
        done
    else
        echo "Bad sum"
        exit 1
    fi
}

function main() {
    if [ -d "continuous" ]; then
        if [ -f "Cargo.toml" ]; then
            cd continuous/rust || exit 1
            packer validate . || exit 1
            packer build . || exit 1
            exit 0
        else
            cd continuous/go || exit 1
            packer validate . || exit 1
            packer build . || exit 1
            exit 0
        fi
    else
        download || exit 1
        rm "${DIR}/${RELEASE}" || exit 1
        exit 0
    fi
}

function send()
{
	if [ -d "${DIR}/continuous" ];then

		for r in "${REMOTES[@]}";do
			for b in "${BRANCHES[@]}";do
				git push "${r}" "${b}"
				git push "${r}" --tags
			done
		done
	fi
}

send

main
